# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set ver.3.3.0
# Copyright (c) 2006-2020 Trustwave and contributors. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# These exclusions remedy false positives in a default Drupal install.
# The exclusions are only active if crs_exclusions_joomla=1 is set.
# See rule 900130 in crs-setup.conf.example for instructions.

#
# [ POLICY ]
#
# Joomla is a complex application that is hard to secure with the CRS. This set
# of exclusion rules aims to sanitise the CRS in a way that allows a default
# Joomla setup to be installed and configured without much hassle as far as
# ModSecurity and the CRS are concerned.
#
# The exclusion rules are fairly straight forward in the sense that they
# disable CRS on a set of well-known parameter fields that are often the source
# of false positives / false alarms of the CRS. This includes namely the
# session cookie, the password fields and article/node bodies.
#
# This is based on two assumptions: - You have a basic trust in your
# authenticated users who are allowed to edit nodes.  - Joomla allows html
# content in nodes and it protects your users from attacks via these fields.
#
# If you think these assumptions are wrong or if you would prefer a more
# careful/secure approach, you can disable the exclusion rules handling of said
# node body false positives. Do this by placing the following directive in
# RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.
#
# SecRuleRemoveById 9006200-9006299
#
# This will mean the CRS remain intact for the editing of node bodies.
#
# The exclusion rules in this file work without the need to define a Drupal
# installation path prefix. Instead they look at the URI from the end - or
# they use regular expressions when targeting dynamic URL. This is all not
# totally foolproof. In some cases, an advanced attacker might be able to
# doctor a request in a way that one of these exclusion rules is triggered
# and the request will bypass all further inspection despite not being a
# Drupal request at all. These exclusion rules could thus be leveraged to
# disable the CRS completely. This is why these rules are off by default.
#
# The CRS rules covered by this ruleset are the rules with Paranoia Level 1 and
# 2. If you chose to run Paranoia Level 3 or 4, you will be facing additional
# false positives which you need to handle yourself.
#
# This set of exclusion rules does not cover any additional Drupal modules
# outside of core.
#
# The exclusion rules are based on Jooma X.
#
# And finally: This set of exclusion rules is in an experimental state. If you
# encounter false positives with the basic Drupal functionality and they are
# not covered by this rule file, then please report them. The aim is to be able
# to install and run Drupal core in a seamless manner protected by
# ModSecurity / CRS up to the paranoia level 2.


SecRule &TX:crs_exclusions_joomla|TX:crs_exclusions_joomla "@eq 0" \
    "id:9006000,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    skipAfter:END-JOOMLA-RULE-EXCLUSIONS"


# [ Table of Contents ]
#
# 9006100 Session Cookie
# 9006110 Password
# 9006120 FREE for use
# 9006130 FREE for use
# 9006140 Content and Descriptions
# 9006150 FREE for use
# 9006160 Form Token
# 9006170 Text Formats and Editors
# 9006180 WYSIWYG/CKEditor Assets and Upload
# 9006190 FREE for use
# 9006200 Content and Descriptions
#
# The rule id range from 9006200 to 9006999 is reserved for future
# use (Joomla modules).


SecRule REQUEST_FILENAME "!@rx ^\/administrator\/(((cache\/\w+|index).php)|components\/com_joomlaupdate\/restore\.php)$"
    "id:52500,\
    phase:1,\
    nolog,\
    pass,\
    skipAfter:END_JOOMLA_ADMINISTRATOR"

SecRule REQUEST_FILENAME "!@rx ^\/administrator\/(((cache\/\w+|index).php)|components\/com_joomlaupdate\/restore\.php)$"
    "id:52501,\
    phase:2,\
    nolog,\
    pass,\
    skipAfter:END_JOOMLA_ADMINISTRATOR"

# Allow request content type PDF & PNG
SecAction "id:52503,\
    phase:1,
    pass,
    nolog,
    t:none \
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type}|application/pdf|image/png',\
    tag:'JOOMLA',\
    msg:'Allow request content type PDF & PNG'"

# Whitelisting exception rule for arguments with a datetime like value
SecRule "ARGS:created|ARGS:publish_up|ARGS:publish_down|ARGS:/^[\w\[\]]*\[created\]$/|ARGS:/^[\w\[\]]*\[created_time\]$/|ARGS:/^[\w\[\]]*\[publish_up\]$/|ARGS:/^[\w\[\]]*\[publish_down\]$/|ARGS:/^[\w\[\]]*\[modified\]$/|ARGS:/^[\w\[\]]*\[registerDate\]$/|ARGS:/^[\w\[\]]*\[lastvisitDate\]$/|ARGS:/^[\w\[\]]*\[lastResetTime\]$/|ARGS:/^[\w\[\]]*\[checked_out_time\]$/" "!@rx ^(?:[0-9]{2,4}-[0-9]{2}-[0-9]{2,4}\s[0-9]{2}:[0-9]{2}:[0-9]{2})?$" \
    "id:52504,\
    phase:2,\
    deny,\
    log,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting exception rule for arguments with a datetime like value'"

# Whitelisting exception rule for 'alias' argument
SecRule ARGS:alias|ARGS:/^[\w\[\]]*\[alias\]$/ "!@rx ^[\p{L}\d\s\-\*\_]*$" \
    "id:52512,\
    phase:2,\
    t:none,\
    t:utf8toUnicode,\
    t:urlDecodeUni,\
    deny,\
    log,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting exception rule for \'alias\' argument'"

SecRule ARGS_GET:object "^jform(?:\[[\w\d\_\.]*\])+$" \
    "id:52515,\
    phase:1,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942430;ARGS:object,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Argument contains characters [ and ]'"

# Whitelist for arguments with restricted SQL & Javascript keywords values
SecRule ARGS_POST:rows|ARGS_POST:plugins "^(?:\w+[\,\;])+\w+$" \
    "id:52516,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942380;ARGS:rows,\
    ctl:ruleRemoveTargetById=941140;ARGS:rows,\
    ctl:ruleRemoveTargetById=942380;ARGS:plugins,\
    ctl:ruleRemoveTargetById=941140;ARGS:plugins,\
    logdata:'Matched Data: %{MATCHED_VAR}',
    tag:'JOOMLA',\
    msg:'Whitelisting \'%{MATCHED_VAR_NAME}\' for restricted SQL & Javascript keywords value'"

# Whitelisting exception rule for argument 'params' with restricted SQL & Javascript keywords values
SecRule ARGS_POST:/^params(?:\[[\w\_\.]*\])+$/ "^(?:\w+[\,\;])+\w+$" \
    "id:52517,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting \'%{MATCHED_VAR_NAME}\' for restricted SQL & Javascript keywords value'"

SecRule &ARGS "@gt %{tx.max_num_args}" \
    "id:52518,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveById=920380,\
    tag:'JOOMLA',\
    msg:'Whitelisting too many request arguments'"

# Exception rule for arguments containing XML values
# Couldn't whitelist this argument due to some values that make raise PCRE limits error and hence not applying the exceptions
SecRule ARGS_NAMES "^(?:data|fields\[introtext\])$" \
    "id:52519,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942130;ARGS:data,\
    ctl:ruleRemoveTargetById=942460;ARGS:data,\
    ctl:ruleRemoveTargetById=941320;ARGS:data,\
    ctl:ruleRemoveTargetById=941340;ARGS:data,\
    ctl:ruleRemoveTargetById=941140;ARGS:data,\
    ctl:ruleRemoveTargetById=942430;ARGS:data,\
    ctl:ruleRemoveTargetById=942440;ARGS:data,\
    ctl:ruleRemoveTargetById=942180;ARGS:data,\
    ctl:ruleRemoveTargetById=942260;ARGS:data,\
    ctl:ruleRemoveTargetById=942200;ARGS:data,\
    ctl:ruleRemoveTargetById=942130;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942460;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=941320;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=941340;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=941140;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942430;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942440;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942180;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942260;ARGS:fields[introtext],\
    ctl:ruleRemoveTargetById=942200;ARGS:fields[introtext],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Exception rule for argument \'%{MATCHED_VAR_NAME}\' that contains XML value'"

# The argument 'jform[articletext]' contains html code that triggers all these false positive rules
SecRule ARGS_NAMES "@streq jform[articletext]" \
    "id:52520,\
    phase:2,\
    pass,\
    ctl:ruleRemoveTargetById=920230;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=920272;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=933151;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=933161;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941100;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941150;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941160;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942150;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942130;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942380;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942410;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942431;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942460;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942490;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941320;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941190;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941200;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941330;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941340;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=941140;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942430;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942440;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942330;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942370;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942180;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942260;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942340;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942210;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942350;ARGS:jform[articletext] \
    ctl:ruleRemoveTargetById=942200;ARGS:jform[articletext] \
    nolog,\
    auditlog,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument with an HTML like value'"

# Whitelisting arguments that contains JSON value
SecRule ARGS:json|ARGS:fields[attribs]|ARGS:fields[images]|ARGS:fields[urls]|ARGS:fields[metadata] "^\{[\w\s\{\}\[\]\/\"\:\,\-\.]+\}$" \
    "id:52521,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942460;ARGS:json,\
    ctl:ruleRemoveTargetById=941120;ARGS:json,\
    ctl:ruleRemoveTargetById=941140;ARGS:json,\
    ctl:ruleRemoveTargetById=942430;ARGS:json,\
    ctl:ruleRemoveTargetById=942330;ARGS:json,\
    ctl:ruleRemoveTargetById=942370;ARGS:json,\
    ctl:ruleRemoveTargetById=942260;ARGS:json,\
    ctl:ruleRemoveTargetById=942340;ARGS:json,\
    ctl:ruleRemoveTargetById=942200;ARGS:json,\
    ctl:ruleRemoveTargetById=942450;ARGS:json,\
    ctl:ruleRemoveTargetById=942460;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942430;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942330;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942370;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942260;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942340;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942200;ARGS:fields[attribs],\
    ctl:ruleRemoveTargetById=942460;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942430;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942330;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942370;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942260;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942340;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942200;ARGS:fields[images],\
    ctl:ruleRemoveTargetById=942460;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942430;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942330;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942370;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942260;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942340;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942200;ARGS:fields[urls],\
    ctl:ruleRemoveTargetById=942460;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942430;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942330;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942370;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942260;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942340;ARGS:fields[metadata],\
    ctl:ruleRemoveTargetById=942200;ARGS:fields[metadata],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting the argument \'%{MATCHED_VAR_NAME}\' that contains JSON value'"

# Whitelisting arguments with a PATH like value and dashes as word separator
SecRule ARGS:jform[image] "^\/?(?:\w*\/)+[\w\-\.]*$" \
    "id:52522,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[image],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'%{MATCHED_VAR_NAME}\' with a PATH like value and dashes as word separator'"

# Whitelisting arguments with a URL like value
SecRule ARGS:jform[clickurl]|ARGS:jform[helpurl]|ARGS:jform[params][link_url]|ARGS:jform[link] "^[\w\?\/\.\=\&\-\:\{\}]+$" \
    "id:52523,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=931100;ARGS:jform[clickurl],\
    ctl:ruleRemoveTargetById=931130;ARGS:jform[clickurl],\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[clickurl],\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[helpurl],\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[params][link_url],\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[link],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'%{MATCHED_VAR_NAME}\' with a URL like value'"

# Whitelisting argument 'jform[link]' with a reference to the 'undefined' javascript
SecRule ARGS:jform[link] "@streq javascript:void(0)" \
    "id:52524,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=941210;ARGS:jform[link],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'jform[link]\' with a reference to the \'undefined\' javascript'"

# Whitelisting argument 'jform[upload_mime]' with a MIME types list value
SecRule ARGS:jform[upload_mime] "^(?:\w+\/[\w\-]+(?:\,\w+\/[\w\-]+)*)?$" \
    "id:52525,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'jform[upload_mime]\' with a MIME types list value'"

# Whitelisting argument 'name' when uploading files
SecRule REQUEST_HEADERS:Content-Type "@beginsWith multipart/form-data" \
    "id:52526,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'name\' for uploading files',
    chain"
    SecRule ARGS:name "^[\w\.\-]+$" \
        "ctl:ruleRemoveTargetById=942430;ARGS:name"

# Whitelisting argument 'referer'
SecRule ARGS:referer "^[\w\?\/\.\=\&\-\:\{\}\[\]]+$" \
    "id:52527,\
    phase:2,\
    t:none,t:urlDecodeUni,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=920230;ARGS:referer,\
    ctl:ruleRemoveTargetById=932115;ARGS:referer,\
    ctl:ruleRemoveTargetById=942460;ARGS:referer,\
    ctl:ruleRemoveTargetById=942430;ARGS:referer,\
    ctl:ruleRemoveTargetById=942431;ARGS:referer,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument \'referer\''"

# Whitelisting arguments with dash word separator
SecRule ARGS_GET:rm[] "^[\w\.\-]+$" \
    "id:52528,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveTargetById=942430;ARGS:rm[],\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting arguments with dash word separator'"

# This rule whitelist some cases when uploading files containning CR-LF-dash-dash sequences that false trigger CRS Rules 200003 & 920150.
# This rule is due to that in the past, there were MIME parsers that had bugs that could be tripped by sticking CR-LF-dash-dash in the data stream, because they would treat any line starting with "--" as a MIME part separator
# Modern MIME parsers prevent this situation so disabling this rule is quite safe
SecRule REQUEST_URI "@endsWith /administrator/index.php" \
    "id:52513,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    ctl:ruleRemoveById=200003,\
    ctl:ruleRemoveById=920150,\
    tag:'JOOMLA',\
    msg:'Whitelisting some cases when uploading files containning CR-LF-dash-dash sequences that false trigger CRS Rules 200003 & 920150'"

# Joomla extension "Profiles" from Mad4Media
# Some GET and POST arguments are UrlEncoded more than once
# Do not whitelist requests with parameter with path traversal pattern (/../)
# Ref: https://extensions.joomla.org/extensions/extension/core-enhancements/file-management/profiles
SecRule ARGS:dir|ARGS:file|ARGS:selectedFiles[] "^(?!.*[\/\\\\]\.\.[\/\\\\]|.*[\/\\\\]\.\.$)(?:[\/\\\\][^\/\\\\]+)+$" \
    "id:52800,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    t:none,t:urlDecodeUni,t:urlDecodeUni,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting Joomla\'s Extension \'Profiles\' with argument \'%{MATCHED_VAR}\' URL-encoded more than once',\
    ctl:ruleRemoveTargetById=920230;ARGS:dir,\
    ctl:ruleRemoveTargetById=920230;ARGS:file,\
    ctl:ruleRemoveTargetById=920230;ARGS:selectedFiles[]"

# Joomla extension "Profiles" from Mad4Media
# Too many "selectedFiles" argument (more than 255 max default) in request
# Ref: https://extensions.joomla.org/extensions/extension/core-enhancements/file-management/profiles
SecRule QUERY_STRING "@rx ^option=com_profiles&.*&view=xhrfiles" \
    "id:52801,\
    phase:2,\
    pass,\
    nolog,\
    auditlog,\
    tag:'JOOMLA',\
    msg:'Whitelisting too many \'selectedFiles[]\' arguments (%{tx.52801_selectedfiles_size} from a total of %{tx.52801_args_size}) in \'Profiles\' Joomla extension',\
    chain"
    SecRule &TX:MAX_NUM_ARGS "@eq 1" \
        "chain"
        SecRule &ARGS "@gt %{tx.max_num_args}"
            "setvar:tx.52801_args_size=%{matched_var},\
            chain"
            SecRule &ARGS:/^(?!selectedFiles\[\]$).*$/ "@le %{tx.max_num_args}" \
                "setvar:tx.52801_selectedfiles_size=%{tx.52801_args_size},\
                setvar:tx.52801_selectedfiles_size=-%{matched_var},\
                ctl:ruleRemoveById=920380"

 # WHY CAPTURE???
SecRule ARGS:/^[\p{L}\p{P}\d]+date_time$/ "!@rx (^[\p{P}\d\s]+$)" \
    "id:52803,\
    phase:2,\
    deny,\
    log,\
    tag:'JOOMLA',\
    msg:'Whitelisting the value of date time argument.',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

SecRule REQUEST_URI "^/administrator/index.php" \
    "id:52805,\
    phase:2,\
    pass,\
    noauditlog,\
	ctl:ruleRemoveTargetById=942440;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942130;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942460;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942430;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942210;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942260;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942300;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942370;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=941320;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942180;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=942340;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=941140;ARGS:editor_body,\
	ctl:ruleRemoveTargetById=941340;ARGS:editor_body,\
	tag:'JOOMLA',\
    msg:'False positives over the argument editor_body.',\
    logdata:'Matched Data: %{MATCHED_VAR}'"

# Whitelisting argument jform
SecRule ARGS:jform[modified_time] "^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$" \
    "id:52806,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[modified_time]"

##VER La URL de esta regla no es consistente con la URL de las reglas de arriba (las del SecMarker)
# Whitelisting argument base64 ARGS:json
SecRule REQUEST_URI "^/administrator/components/com_joomlaupdate/restore\.php$" \
    "id:52807,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    chain,"
	SecRule ARGS:json "^[\w\s\{\}\[\]\/\"\:\,\-\.\+\=]+$" \
		"ctl:ruleRemoveTargetById=932140;ARGS:json,\
		ctl:ruleRemoveTargetById=941120;ARGS:json,\
		ctl:ruleRemoveTargetById=941140;ARGS:json,\
		ctl:ruleRemoveTargetById=942120;ARGS:json,\
		ctl:ruleRemoveTargetById=942340;ARGS:json,\
		ctl:ruleRemoveTargetById=942450;ARGS:json"

# Whitelisting argument HTML ARGS:jform[description]
SecRule REQUEST_URI "^/administrator/index\.php" \
    "id:52808,\
    phase:2,\
    pass,\
    chain"
	SecRule ARGS:jform[description] "^[\p{L}\s\.\,\<\/\>\+\(\)\?\=\"\-\d\:\;\'\\_\x{c2}\x{a0}\&]*$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
		ctl:ruleRemoveTargetById=942130;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942460;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=941320;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=941330;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=941340;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=941140;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942430;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942370;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942180;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942260;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942210;ARGS:jform[description],\
		ctl:ruleRemoveTargetById=942200;ARGS:jform[description]"

# The argument 'jform[title]' contains user entry text
SecRule ARGS:jform[title] "^[\p{L}\p{P}\d\s\+\<\>\=\´]*$" \
    "id:52809,\
    phase:2,\
    t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
    pass,\
    ctl:ruleRemoveTargetById=920272;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942460;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942430;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942440;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942370;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942260;ARGS:jform[title],\
    ctl:ruleRemoveTargetById=942110;ARGS:jform[title],\
	nolog,\
    auditlog,\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'JOOMLA',\
    msg:'Whitelisting argument that contains user entry text'"

# Whitelisting argument ARGS:filter[search]
SecRule REQUEST_FILENAME "@endsWith /administrator/index.php" \
    "id:52810,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
	SecRule ARGS:filter[search] "^[\w\d\- \´]+$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
		ctl:ruleRemoveTargetById=942430;ARGS:filter[search],\
		ctl:ruleRemoveTargetById=942260;ARGS:filter[search]"

# Whitelisting argument ARGS:jform[offline_message]
SecRule REQUEST_FILENAME "@endsWith /administrator/index.php" \
    "id:52811,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,
    chain"
	SecRule ARGS:jform[offline_message] "^[\p{L}\s\.\,\<\/\>\+]+$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
		ctl:ruleRemoveTargetById=941320;ARGS:jform[offline_message]"

# Whitelisting argument ARGS:jform[helpurl]
SecRule REQUEST_FILENAME "@endsWith /administrator/index.php" \
    "id:52812,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
	SecRule ARGS:jform[helpurl] "^(?:ht|f)tps?://(.*)$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
		ctl:ruleRemoveTargetById=931130;ARGS:jform[helpurl]"

# Whitelisting argument ARGS:jform[com_fields][featured-articles-custom-title]
SecRule REQUEST_FILENAME "@endsWith /administrator/index.php" \
    "id:52813,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
	SecRule ARGS:jform[com_fields][featured-articles-custom-title] "^[\p{L}\d\_\¿\?\s]+$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
		ctl:ruleRemoveTargetById=942260;ARGS:jform[com_fields][featured-articles-custom-title],\
        ctl:ruleRemoveTargetById=942110;ARGS:jform[com_fields][featured-articles-custom-title]"

SecRule QUERY_STRING "^option=com_content&layout=edit" \
    "id:52814,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    ctl:ruleRemoveById=941000"

### LOOK HERE:REMOVE
# Whitelisting argument ARGS:fields[descripcion]
SecRule REQUEST_URI "^/administrator/cache/" \
    "id:52815,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:fields[descripcion] "^[\p{L}\s\d\/\.\:\<\>\,\=\"\-]*$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
        ctl:ruleRemoveTargetById=920272;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=941150;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=941320;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=942130;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=942260;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=942430;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=942431;ARGS:fields[descripcion],,\
        ctl:ruleRemoveTargetById=942460;ARGS:fields[descripcion]"

SecRule ARGS_NAMES "@streq jform[id]" \
    "id:52816,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
    ctl:ruleRemoveTargetById=921180;ARGS_NAMES:jform[id]"

### LOOK HERE:REMOVE
# Whitelisting argument ARGS:fields[modelo]
SecRule REQUEST_URI "@rx ^/administrator/cache/" \
    "id:52817,phase:2,chain,pass,nolog,noauditlog,rev:'$Revision: 149 $'"
    SecRule ARGS:fields[modelo] "^[\/\w\s\=\[\]\(\)\;\-\<\\\>\$\"\,\p{L}\:\']*$" "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni \
        ctl:ruleRemoveTargetById=920272;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=933161;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=941320;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=941330;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942130;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942200;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942260;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942330;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942340;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942430;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942431;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942460;ARGS:fields[modelo],\
        ctl:ruleRemoveTargetById=942490;ARGS:fields[modelo]"


# Whitelisting argument ARGS:sql
SecRule REQUEST_URI "@rx ^/administrator/cache/" \
    "id:52818,
    phase:2,
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule ARGS:sql|ARGS_GET:sql|ARGS:query "@rx ^[\*\w\s\'\'\%\`\=\(\)]*$" \
        "t:none,t:urlDecode,t:utf8toUnicode,t:urlDecodeUni,\
        ctl:ruleRemoveTargetById=920230;ARGS:sql,\
        ctl:ruleRemoveTargetById=920230;ARGS:query,\
        ctl:ruleRemoveTargetById=921151;ARGS:sql,\
        ctl:ruleRemoveTargetById=921151;ARGS_GET:sql,\
        ctl:ruleRemoveTargetById=942100;ARGS:sql,\
        ctl:ruleRemoveTargetById=942100;ARGS:query,\
        ctl:ruleRemoveTargetById=942180;ARGS:sql,\
        ctl:ruleRemoveTargetById=942180;ARGS:query,\
        ctl:ruleRemoveTargetById=942260;ARGS:sql,\
        ctl:ruleRemoveTargetById=942260;ARGS:query,\
        ctl:ruleRemoveTargetById=942370;ARGS:sql,\
        ctl:ruleRemoveTargetById=942370;ARGS:query,\
        ctl:ruleRemoveTargetById=942380;ARGS:sql,\
        ctl:ruleRemoveTargetById=942380;ARGS:query,\
        ctl:ruleRemoveTargetById=942431;ARGS:sql,\
        ctl:ruleRemoveTargetById=942431;ARGS:query,\
        ctl:ruleRemoveTargetById=942460;ARGS:query,\
        ctl:ruleRemoveTargetById=942480;ARGS:sql,\
        ctl:ruleRemoveTargetById=942480;ARGS:query"


# Whitelisting argument REQUEST_HEADERS:referer
SecRule REQUEST_URI "@rx ^/administrator/cache/" \
    "id:52819,\
    phase:1,\
    pass,\
    nolog,\
    noauditlog,\
    chain"
    SecRule REQUEST_HEADERS:referer "@rx ^[\*\w\s\'\%\`\=\(\)\&\/\.\?\:]*$" \
        "t:none,t:utf8toUnicode,t:urlDecodeUni,\
        ctl:ruleRemoveTargetById=920272;REQUEST_HEADERS:referer,\
        ctl:ruleRemoveTargetById=942100;REQUEST_HEADERS:referer"

SecRule REQUEST_URI "^/administrator/cache/"
    "id:52820,\
    phase:2,\
    pass,\
    nolog,\
    noauditlog,\
	ctl:ruleRemoveTargetById=920272;ARGS:sql,\
	ctl:ruleRemoveTargetById=920272;ARGS:query,\
	ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920272;REQUEST_URI"


######
# Rules with regexp match on naming (waiting for https://github.com/SpiderLabs/ModSecurity/pull/1683)


# Arguments name contains characters [ and ]
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^jform(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^data(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^filter(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^items(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^params(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^columns(?:\[[\w\_\-\.]*\])+$/
SecRuleUpdateTargetById 942430 !ARGS_NAMES:/^where(?:\[[\w\_\-\.]*\])+$/

# Se crea whitelist
SecRuleUpdateTargetById 942430 !ARGS:/^[\p{L}\p{P}\d]+date_time$/

# Exception rule for 'params' argument with restricted SQL & Javascript keywords value
SecRuleUpdateTargetById 941140 !ARGS:/^params(?:\[[\w\_\.]*\])+$/

# Exception rules for arguments that have a datetime value that false trigger CRS rule 942430
SecRuleUpdateTargetById 942430 !ARGS:created
SecRuleUpdateTargetById 942430 !ARGS:publish_up
SecRuleUpdateTargetById 942430 !ARGS:publish_down
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[created\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[created_time\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[publish_up\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[publish_down\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[modified\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[registerDate\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[lastvisitDate\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[lastResetTime\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[checked_out_time\]$/

# Exception rules for 'alias' arguments
SecRuleUpdateTargetById 942460 !ARGS:alias
SecRuleUpdateTargetById 942430 !ARGS:alias
SecRuleUpdateTargetById 942260 !ARGS:alias
SecRuleUpdateTargetById 942460 !ARGS:/^[\w\[\]]*\[alias\]$/
SecRuleUpdateTargetById 942430 !ARGS:/^[\w\[\]]*\[alias\]$/
SecRuleUpdateTargetById 942260 !ARGS:/^[\w\[\]]*\[alias\]$/


SecMarker "END-JOOMLA-RULE-EXCLUSIONS"